<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inclusão de Cliente - Intracor</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/clientes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div class="main-wrapper">
        <%- include('partials/header') %>
        
        <header class="page-header">
            <h2><i class="fa-solid fa-plus"></i> Inclusão de Cliente</h2>
            <div class="page-actions">
                <button class="btn-excluir"><i class="fa-solid fa-trash"></i> Excluir </button>
                <button class="btn-salvar"><i class="fa-solid fa-save"></i> Salvar</button>
                <a href="/clientes" class="btn-cancelar"><i class="fa-solid fa-times"></i> Cancelar</a>
            </div>
        </header>
        
        <main class="form-container">

            <div class="form-main">
                <section class="form-section">
                    <div class="form-row">
                        <div class="form-group large">
                            <label for="cliente">Cliente</label>
                            <input type="text" id="cliente" value="Nome Completo">
                        </div>
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="text" id="telefone" value="" maxlength="13">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" value="000.000.000-00" maxlength="14">
                        </div>
                        <div class="form-group">
                            <label for="preposto">Preposto</label>
                            <select id="preposto">
                                <option value="">Carregando usuários...</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" id="email" value="email@email.com.br">
                        </div>
                        <div class="form-group">
                            <label for="profissao">Profissão</label>
                            <select id="profissao">
                                <option value="medico" selected>Médico</option>
                                <option value="engenheiro">Engenheiro</option>
                                <option value="advogado">Advogado</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="nascimento">Data de nascimento</label>
                            <input type="text" id="nascimento" value="00/00/0000">
                        </div>
                         <div class="form-group">
                            <label for="grupoEconomico">Grupo Econômico</label>
                            <select id="grupoEconomico">
                                <option value="">Carregando grupos economicos...</option>
                            </select>
                        </div>
                    </div>
                </section>
                <section class="form-section">
                    <h4>Endereço</h4>
                    <div class="form-row">
                        <div class="form-group large">
                            <label for="logradouro">Logradouro</label>
                            <input type="text" id="logradouro" value="Rua ">
                        </div>
                        <div class="form-group small">
                            <label for="numero">Nº</label>
                            <input type="text" id="numero" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bairro">Bairro</label>
                            <input type="text" id="bairro" value="Bairro">
                        </div>
                        <div class="form-group">
                            <label for="cidade">Cidade</label>
                            <select id="cidade">
                                <option value="">Carregando cidades...</option>
                            </select>
                        </div>
                    </div>
                </section>
                <section class="form-section">
                    <h4>Observações</h4>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <textarea id="observacoes">-</textarea>
                        </div>
                    </div>
                </section>
            </div>

            <aside class="form-sidebar">
                <input type="file" id="file-input" style="display: none;" multiple>
                
                <button class="btn-anexar" id="btn-anexar-trigger"><i class="fa-solid fa-paperclip"></i> Anexar Documento</button>
                
                <div class="file-list">
                    <ul id="file-list-ul">
                    </ul>
                </div>

            </aside>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            carregarUsuarios(); 
            carregarGrEconomico(); 
            carregarCidades();
            
            //Captura o id passado no endereço
            const urlParts = window.location.pathname.split('/');
            const clienteId = urlParts[urlParts.length - 1];
            
            console.log('ID do cliente capturado:', clienteId);
            
            if (clienteId && clienteId !== 'incluir' && clienteId !== 'alterar') {
                carregarDadosCliente(clienteId);
                document.querySelector('h2').innerHTML = '<i class="fa-solid fa-edit"></i> Alteração de Cliente';
                
                document.querySelector('.btn-excluir').style.display = 'inline-block';
            } else {
                document.querySelector('.btn-excluir').style.display = 'none';
            }
        });

        //PREPOSTO
        async function carregarUsuarios() {
            try {
                const response = await fetch('/usuario/getUsuList');
                const data = await response.json();
                
                if (data.success && data.usuarios) {
                    preencherSelectUsuarios(data.usuarios);
                } else {
                    console.error('Erro ao carregar usuários:', data.error);
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
            }
        }

        function preencherSelectUsuarios(usuarios) {
            const selectPreposto = document.getElementById('preposto');
            
            selectPreposto.innerHTML = '<option value="">Selecione um preposto</option>';
            
            usuarios.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.usuario_id;
                option.textContent = usuario.nome;
                selectPreposto.appendChild(option);
            });

            document.getElementById('preposto').addEventListener('change', function() {
                const usuario_id = this.value;
            });
        }
        
        //GRUPOECONOMICO
        async function carregarGrEconomico() {
            try {
                const response = await fetch('/clientes/getGrEconomico');
                const data = await response.json();
                
                if (data.success && data.grEconomicos) {
                    preencherSelectGrEconomico(data.grEconomicos);
                } else {
                    console.error('Erro ao carregar Grupos Econômicos:', data.error);
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
            }
        }

        function preencherSelectGrEconomico(grEconomicos) {
            const selectGrEconomico = document.getElementById('grupoEconomico');
            
            selectGrEconomico.innerHTML = '<option value="">Selecione um grupo econômico</option>';
            
            grEconomicos.forEach(grEconomico => {
                const option = document.createElement('option');
                option.value = grEconomico.greconomico_id;
                option.textContent = grEconomico.descr;
                selectGrEconomico.appendChild(option);
            });

            document.getElementById('grupoEconomico').addEventListener('change', function() {
                const greconomico_id = this.value;
            });
        }

        
        // Função para carregar dados do cliente específico
        async function carregarDadosCliente(clienteId) {
            try {
                const response = await fetch(`/clientes/getCliente/${clienteId}`);
                const data = await response.json();
                
                if (data.success && data.cliente) {
                    preencherFormulario(data.cliente);
                } else {
                    console.error('Erro ao carregar dados do cliente:', data.error);
                    alert('Erro ao carregar dados do cliente');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
            }
        }

        function preencherSelectCidades(cidades) {
            const selectCidades = document.getElementById('cidade');
            
            selectCidades.innerHTML = '<option value="">Selecione uma cidade </option>';
            
            cidades.forEach(cidade => {
                const option = document.createElement('option');
                option.value = cidade.cidade_id;
                option.textContent = cidade.descr_cidade;
                selectCidades.appendChild(option);
            });

            document.getElementById('cidade').addEventListener('change', function() {
                const cidade_id = this.value;
            });
        }
        
        // Função para preencher o formulário com os dados do cliente
        async function preencherFormulario(cliente) {
            
            document.getElementById('cliente').value = cliente.nome || '';
            document.getElementById('telefone').value = cliente.telefone || '';
            document.getElementById('cpf').value = cliente.cpf || '';
            document.getElementById('email').value = cliente.email || '';
            document.getElementById('nascimento').value = cliente.dt_nasc || '';
            document.getElementById('logradouro').value = cliente.descr_ender || '';
            document.getElementById('numero').value = cliente.nro_ender || '';
            document.getElementById('bairro').value = cliente.bairro_ender || '';
            document.getElementById('observacoes').value = cliente.obs || '';

            await Promise.all([
                carregarUsuarios().then(() => {
                    document.getElementById('preposto').value = cliente.usuprep_id || '';
                }),
                carregarGrEconomico().then(() => {
                    document.getElementById('grupoEconomico').value = cliente.greconomico_id || '';
                }),
                carregarCidades().then(() => {
                    document.getElementById('cidade').value = cliente.cidade_id || '';
                })
            ]);

            if (cliente.profissao === 'MEDICO'){
                document.getElementById('profissao').value = 'medico';
            } else if (cliente.profissao === 'ENGENHEIRO'){
                document.getElementById('profissao').value = 'engenheiro';
            } else if (cliente.profissao === 'ADVOGADO'){
                document.getElementById('profissao').value = 'advogado';
            }
        }
        

        async function carregarCidades() {
            try {
                const response = await fetch('/clientes/getCidades');
                const data = await response.json();
                
                if (data.success && data.cidades) {
                    preencherSelectCidades(data.cidades);
                } else {
                    console.error('Erro ao carregar cidades:', data.error);
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
            }
        }

        //adiciona mascara telefone
        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 11) {
                // Aplica a máscara: XXX.XXX.XXX-XX
                if (value.length > 9) {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '$1-$2-$3');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1-$2-$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{1,3})/, '$1-$2');
                }
                
                e.target.value = value;
            }
        });

        //adiciona mascara no cpf
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 11) {
                // Aplica a máscara: XXX.XXX.XXX-XX
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                }
                
                e.target.value = value;
            }
        });

        // Função para aplicar máscara de data
        function aplicarMascaraData(input) {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                // Limita a 8 dígitos
                if (value.length > 8) {
                    value = value.substring(0, 8);
                }
                
                // Aplica máscara
                if (value.length > 4) {
                    value = value.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{0,2})/, '$1/$2');
                }
                
                e.target.value = value;
                
                // Validação visual em tempo real
                validarDataEmTempoReal(e.target);
            });
            
            input.addEventListener('blur', function(e) {
                validarDataCompleta(e.target);
            });
            
            input.addEventListener('keydown', function(e) {
                // Permite navegação com teclado
                if (e.key === 'Backspace' || e.key === 'Delete') {
                    setTimeout(() => {
                        validarDataEmTempoReal(e.target);
                    }, 10);
                }
            });
        }

        // Validação em tempo real (enquanto digita)
        function validarDataEmTempoReal(input) {
            const value = input.value;
            
            // Remove classes anteriores
            input.classList.remove('data-valida', 'data-invalida', 'data-incompleta');
            
            if (value.length === 0) {
                return;
            }
            
            if (value.length === 10) {
                // Data completa - valida
                if (validarData(value)) {
                    input.classList.add('data-valida');
                } else {
                    input.classList.add('data-invalida');
                }
            } else {
                // Data incompleta
                input.classList.add('data-incompleta');
            }
        }

        // Validação completa da data
        function validarDataCompleta(input) {
            const value = input.value;
            
            if (value && value.length === 10) {
                const [dia, mes, ano] = value.split('/').map(Number);
                
                if (!validarData(value)) {
                    alert('Data inválida! Verifique o dia, mês e ano.');
                    input.focus();
                    input.select();
                }
            }
        }

        // Função para validar data
        function validarData(dataString) {
            if (!dataString || dataString.length !== 10) return false;
            
            const [dia, mes, ano] = dataString.split('/').map(Number);
            
            // Validações básicas
            if (mes < 1 || mes > 12) return false;
            if (dia < 1 || dia > 31) return false;
            if (ano < 1900 || ano > new Date().getFullYear()) return false;
            
            // Valida dias do mês
            const diasNoMes = new Date(ano, mes, 0).getDate();
            if (dia > diasNoMes) return false;
            
            // Data não pode ser futura (para data de nascimento)
            const dataDigitada = new Date(ano, mes - 1, dia);
            const hoje = new Date();
            if (dataDigitada > hoje) return false;
            
            return true;
        }

        // Aplica a máscara quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            aplicarMascaraData(document.getElementById('nascimento'));
        });

        // ARQUIVOS DO CLIENTE
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Seleciona os elementos ---
            const anexarButton = document.getElementById('btn-anexar-trigger');
            const fileInput = document.getElementById('file-input');
            const fileListUl = document.getElementById('file-list-ul');

            // --- 2. Ação de clicar no botão "Anexar Documento" ---
            // Faz o clique no botão visível disparar o clique no input escondido
            anexarButton.addEventListener('click', (e) => {
                e.preventDefault(); // Impede o botão de submeter um formulário
                fileInput.click();
            });

            // --- 3. Ação de selecionar um arquivo ---
            // Disparado quando o usuário escolhe os arquivos
            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files.length) {
                    return;
                }

                // Cria um item na lista para cada arquivo selecionado
                for (const file of files) {
                    const iconClass = getFileIconClass(file.name);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span><i class="fa-solid ${iconClass}"></i> ${file.name}</span>
                        <i class="fa-solid fa-trash-can file-delete-icon"></i>
                    `;
                    fileListUl.appendChild(li);
                }

                // Limpa o input para permitir selecionar o mesmo arquivo de novo
                e.target.value = null; 
            });

            // --- 4. Ação de excluir um arquivo (usando delegação de evento) ---
            // Escuta cliques na LISTA (ul) inteira
            fileListUl.addEventListener('click', (e) => {
                // Verifica se o clique foi em um elemento com a classe 'file-delete-icon'
                if (e.target.classList.contains('file-delete-icon')) {
                    // Pega o 'li' pai do ícone e o remove
                    const li = e.target.closest('li');
                    if (li) {
                        li.remove();
                    }
                }
            });

            // --- Função Auxiliar: Define o ícone com base na extensão ---
            function getFileIconClass(fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                switch (extension) {
                    case 'pdf':
                        return 'fa-file-pdf';
                    case 'doc':
                    case 'docx':
                        return 'fa-file-word';
                    case 'xls':
                    case 'xlsx':
                        return 'fa-file-excel';
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        return 'fa-file-image';
                    default:
                        return 'fa-file-lines'; // Ícone genérico
                }
            }
            
        });

        //INSERE CLIENTE
        document.querySelector('.btn-salvar').addEventListener('click', function(e) {
            e.preventDefault();
            salvarCliente();
        });

        document.querySelector('.btn-excluir').addEventListener('click', function(e) {
            e.preventDefault();
            excluirCliente();
        });

        async function salvarCliente() {
            const urlParts = window.location.pathname.split('/');
            const clienteId = urlParts[urlParts.length - 1];
            
            function limparCPF(cpf) {
                return cpf.replace(/\D/g, '');
            }
            
            const dadosCliente = {
                nome:               document.getElementById('cliente').value,
                telefone:           document.getElementById('telefone').value,
                cpf:                limparCPF(document.getElementById('cpf').value),
                usuprep_id:         document.getElementById('preposto').value,
                email:              document.getElementById('email').value,
                profissao:          document.getElementById('profissao').value,
                dt_nasc:            document.getElementById('nascimento').value,
                greconomico_id:     document.getElementById('grupoEconomico').value,
                descr_ender:        document.getElementById('logradouro').value,
                nro_ender:          document.getElementById('numero').value,
                bairro_ender:       document.getElementById('bairro').value,
                cidade_id:          document.getElementById('cidade').value,
                obs:                document.getElementById('observacoes').value,
                cliente_id: clienteId
            };
            
            // Validações básicas
            if (!dadosCliente.nome || dadosCliente.nome === 'Nome Completo') {
                alert('Por favor, informe o nome do cliente');
                return;
            }

            if (!dadosCliente.telefone || dadosCliente.telefone.length < 13) {
                alert('Por favor, informe um número de telefone válido!');
                return;
            }

            if (!dadosCliente.cpf || dadosCliente.cpf.length !== 11) {
                alert('Por favor, informe um CPF válido (11 dígitos)');
                return;
            }

            try {
                let url, method;
                
                if (clienteId && clienteId !== 'incluir' && clienteId !== 'alterar') {
                    dadosCliente.cliente_id = clienteId;
                    url = '/clientes/atlzCliente';
                    method = 'PUT';
                } else {
                    url = '/clientes/incluir';
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosCliente)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erro ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    alert(clienteId ? 'Cliente alterado com sucesso!' : 'Cliente salvo com sucesso!');
                    window.location.href = '/clientes';
                } else {
                    alert('Erro ao salvar cliente: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar cliente: ' + error.message);
            }
        }

        async function excluirCliente() {
            const urlParts = window.location.pathname.split('/');
            const clienteId = urlParts[urlParts.length - 1];

            try {
                let url, method;
                    
                    url = '/clientes/excluir';
                    method = 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ clienteId: clienteId }) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erro ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('Cliente excluído com sucesso!');
                    window.location.href = '/clientes';
                } else {
                    alert('Erro ao excluir cliente: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir cliente: ' + error.message);
            }
        }
    </script>
</body>
</html>