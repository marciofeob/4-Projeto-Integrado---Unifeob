<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Intracor</title>
    
    <link rel="stylesheet" href="/css/style.css"> 
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="main-wrapper">
        <%- include('partials/header') %>
        
        <main class="admin-container">
            <h2>Painel Administrativo</h2>

            <div class="admin-tabs">
                <button class="tab-button active" onclick="openTab(event, 'tab-logs')">Logs de Auditoria</button>
                <button class="tab-button" onclick="openTab(event, 'tab-usuarios')">Manutenção de Usuários</button>
                <button class="tab-button" onclick="openTab(event, 'tab-relatorios')">Gerar Relatório</button>
            </div>

            <div id="tab-logs" class="tab-content active">
                <h3>Logs do Sistema</h3>
                <div class="table-container">
                    <table class="data-table" id="table-logs">
                        <thead>
                            <tr>
                                <th>Usuário</th>
                                <th>Ação</th>
                                <th>Data/Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="text-align: center;">Carregando logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-usuarios" class="tab-content">
                <div class="row">
                    <div class="col-sm">
                        <h3>Usuários do Sistema</h3>
                    </div>
                    <div class="col-sm" style="text-align: right">
                        <a href="/usuario/incluir">
                            <button class="btn-include">
                                <i class="fa-solid fa-plus"></i> Adicionar Usuário
                            </button>
                        </a>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="table-usuarios">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nome</th>
                                <th>Login (cd_usu_bd)</th>
                                <th>Nível</th>
                                <th>Função</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center;">Carregando usuarios...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-relatorios" class="tab-content">
                <h3>Relatórios</h3>
                <div class="periodo-container">
                    <label for="data">Selecione o período</label>
                    <div class="inputs">
                        <input type="date" id="data-inicio" name="data-inicio">
                        <span class="ate">Até</span>
                        <input type="date" id="data-fim" name="data-fim">
                    </div>
                </div>
                <button id="btn-gerar-relatorio" class="btn-include">
                    <i class="fa-solid fa-file-pdf"></i> Gerar Relatório
                </button>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            carregarAuditoriaLogs();
            carregarUsuarios();
        });
        
        function openTab(evt, tabName) {
            // Esconde todos os conteúdos
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }

            // Remove 'active' de todos os botões
            const tabbuttons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }

            // Mostra a aba clicada e ativa o botão
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        async function carregarAuditoriaLogs() {
            try {
                const response = await fetch('/admin/getLogsAuditoria');
                const data = await response.json();
                
                console.log('Logs:', data);

                if (data.success) {
                    atualizarTabelaLogs(data.logsAuditoria);
                } else {
                    console.error('Erro ao carregar logs de auditoria:', data.error);
                }
            } catch (error) {
                console.error('Erro: ', error);
            }
        }

        function atualizarTabelaLogs(logsAuditoria) {
            const tbody = document.querySelector('#table-logs tbody');
            
            if (logsAuditoria && logsAuditoria.length > 0) {
                tbody.innerHTML = logsAuditoria.map(log => `
                    <tr>
                        <td>${log.usuario || 'N/A'}</td>
                        <td>${log.acao || 'N/A'}</td>
                        <td>${log.dt_ref || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhum log de auditoria encontrado!</td></tr>';
            }
        }

        async function carregarUsuarios() {
            try {
                const response = await fetch('/usuario/getUsuarios');
                const data = await response.json();
                
                console.log('Usuários:', data);

                if (data.success) {
                    atualizarTabelaUsuarios(data.usuarios);
                } else {
                    console.error('Erro ao carregar usuarios:', data.error);
                }
            } catch (error) {
                console.error('Erro: ', error);
            }
        }

        function atualizarTabelaUsuarios(usuarios) {
            const tbody = document.querySelector('#table-usuarios tbody');
            
            if (usuarios && usuarios.length > 0) {
                tbody.innerHTML = usuarios.map(usuario => `
                    <tr>
                        <td>
                            <a href="/usuario/alterar/${usuario.usuario_id}">
                                <span class="fa fa-edit" style="text-align: center; color:blue"></span>
                            </a>
                        </td>
                        <td>${usuario.nome || 'N/A'}</td>
                        <td>${usuario.cd_usu_bd || 'N/A'}</td>
                        <td>${usuario.descr_tpacessusu || 'N/A'}</td>
                        <td>${usuario.descr_funcaousu || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum usuário encontrado!</td></tr>';
            }
        }
        // Lógica do Botão de Relatório
        document.getElementById('btn-gerar-relatorio').addEventListener('click', function() {
            const inicio = document.getElementById('data-inicio').value;
            const fim = document.getElementById('data-fim').value;

            if (!inicio || !fim) {
                alert('Por favor, selecione as datas de início e fim.');
                return;
            }

            const url = `/admin/relatorio/gerar?dataInicio=${inicio}&dataFim=${fim}`;
            window.open(url, '_blank');
        });
    </script>
</body>
</html>